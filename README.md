# Argo

# Links
- [Getting started](https://argoproj.github.io/argo-cd/getting_started/)
- [kustomize](https://github.com/kubernetes-sigs/kustomize/blob/master/README.md)

## Prerequisite:
  - Minikube & Argo on your local machine
    ```
    $ brew cask install minikube
    $ brew install hyperkit
    $ minikube config set vm-driver hyperkit
    $ brew tap argoproj/tap
    $ brew install argoproj/tap/argocd
    ```





## Run Argo with example K8s app
1. Setup the argo application
  - Load environment variables
    ```
    $ . ./.env
    ```
    - or
    ```
    $ export MINIKUBE_PROFILE=argo DOCKER_IMAGE_NAME=hello-node:v1 K8S_NAMESPACE=argocd NAME_PREFIX=dev
    ```
  - Spin up a cluster with minikube  
    ```
    $ minikube start --kubernetes-version v1.15.7 -p $MINIKUBE_PROFILE
    $ kubectl create namespace $K8S_NAMESPACE
    $ kubectl apply -n $K8S_NAMESPACE -f argo/install.yaml
    $ kubectl create clusterrolebinding YOURNAME-cluster-admin-binding --clusterrole=cluster-admin --user=YOUREMAIL@gmail.com
    $ ./build.sh
    $ ./up.sh
    $ minikube service $NAME_PREFIX-node-express-api --namespace=$K8S_NAMESPACE -p $MINIKUBE_PROFILE
    ```
2. View Argo's GUI
  - Get the admin password
    ```
    $ ./argo/get-argo-password.sh
      argocd-server-xxxxxxxxx-xxxxx
    ```
  - Go to https://localhost:8080/
    username: admin
    password: argocd-server-xxxxxxxxx-xxxxx








## Setup semi-manually
1. Setup your cluster
    ```
    $ minikube start --kubernetes-version v1.15.7 -p argo
    $ eval $(minikube docker-env -p argo)
    $ kubectl config get-contexts
    ```

2. Install Argo CD
    ```
    $ kubectl create namespace argocd
    $ kubectl apply -n argocd -f argo/install.yaml
    ```
  - this will create 2 new resources "CustomResourceDefinition" project & application
    ```
    $ kubectl create clusterrolebinding YOURNAME-cluster-admin-binding --clusterrole=cluster-admin --user=YOUREMAIL@gmail.com
    ```

3. Build local docker image with the k8s docker engine
  - You want to make sure you build the docker image inside the cluster so it will have access to it
    ```
    $ eval $(minikube docker-env -p argo)
    $ cd ./docker
    $ ./build-local-image.sh
    $ docker images
    ```

4. Test your k8s application locally
    ```
    $ cd ./k8s
    $ kubectl create namespace testing-k8s
    $ ./run-local.sh
    $ minikube service test-node-express-api --namespace=testing-k8s -p argo
    $ kubectl delete namespace testing-k8s
    ```



5. Run the Argo CD server locally
  - By default, the Argo CD API server is not exposed with an external IP. 
  - To access the API server, choose one of the following techniques to expose the Argo CD API server:
    (1) ***Port Forwarding***
      - Kubectl port-forwarding can also be used to connect to the API server without exposing the service.
        ```
        $ kubectl port-forward svc/argocd-server -n argocd 8080:443
        ```
      - The API server can then be accessed using the localhost:8080

6. Login Using The CLI
  - The initial password is autogenerated to be the pod name of the Argo CD API server. Get the password with the command:
    $ kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
    argocd-server-xxxxxxxxx-xxxxx
  - go to https://localhost:8080/
    username: admin
    password: argocd-server-xxxxxxxxx-xxxxx


7. Create an Application
  - Get the admin password
    ```
    $ ./argo/get-argo-password.sh
      argocd-server-xxxxxxxxx-xxxxx
    ```
  - Go to https://localhost:8080/
    username: admin
    password: argocd-server-xxxxxxxxx-xxxxx
  - Run an Argo app
    ```
    $ cd argo
    $ kubectl apply -n argocd -f argo.yaml
    ```
  - Access your cluster
    ```
    $ minikube service test-node-express-api --namespace=argocd -p argo
    ```







